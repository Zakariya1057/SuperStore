//
//  ShowProductResultsInteractor.swift
//  SuperStore
//
//  Created by Zakariya Mohummed on 02/03/2021.
//  Copyright (c) 2021 Zakariya Mohummed. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

protocol ShowProductResultsBusinessLogic
{
    func getResults(request: ShowProductResults.GetResults.Request)
    
    var searchQueryRequest: SearchQueryRequest { get set }
    var selectedRefineOptions: SelectedRefineOptions { get set }
    var searchRefine: SearchRefine { get set }
    
    var selectedListID: Int? { get set }
    var selectedProductStoreTypeID: Int? { get set }
    
    func getListItems(request: ShowProductResults.GetListItems.Request)
    func createListItem(request: ShowProductResults.CreateListItem.Request)
    func updateListItem(request: ShowProductResults.UpdateListItem.Request)
}

protocol ShowProductResultsDataStore
{
    var searchQueryRequest: SearchQueryRequest { get set }
    var selectedRefineOptions: SelectedRefineOptions { get set }
    var searchRefine: SearchRefine { get set }
    
    var selectedListID: Int? { get set }
    var selectedProductStoreTypeID: Int? { get set }
}

class ShowProductResultsInteractor: ShowProductResultsBusinessLogic, ShowProductResultsDataStore
{
    var presenter: ShowProductResultsPresentationLogic?
    
    var searchWorker: SearchWorker = SearchWorker(searchAPI: SearchAPI())
    var listItemWorker: ListItemWorker = ListItemWorker(listItemAPI: ListItemAPI())
    
    var userSession = UserSessionWorker()
    
    var searchRefine: SearchRefine = SearchRefine(brands: [], categories: [])
    var searchQueryRequest: SearchQueryRequest = SearchQueryRequest(storeTypeID: 0, query: "", type: "")
    
    var selectedListID: Int?
    var selectedProductStoreTypeID: Int?
    
    var selectedRefineOptions: SelectedRefineOptions = SelectedRefineOptions() {
        didSet {
            refineResults()
        }
    }
    
    func getResults(request: ShowProductResults.GetResults.Request)
    {
        // Unique Brands. Unique Categories
        var uniqueBrands: [String: Int] = [:]
        var uniqueCategories: [String: Int] = [:]
        
        let page: Int = request.page
        
        searchWorker.getProductResults(query: searchQueryRequest, page: page) { (results: ProductResultsModel?, error: String?) in
            
            if let results = results {
                for product in results.products {
                    if let brand = product.brand {
                        uniqueBrands[brand] = 1
                        uniqueCategories[product.childCategoryName!] = 1
                    }
                }
                
                self.searchRefine.brands = uniqueBrands.compactMap{$0.key}
                self.searchRefine.categories = uniqueCategories.compactMap{$0.key}
            }

            var response = ShowProductResults.GetResults.Response(products: results?.products ?? [], paginate: results?.paginate, error: error)
            
            if error != nil {
                response.offline = !self.userSession.isOnline()
            }
            
            self.presenter?.presentResults(response: response)
        }
    
    }
    

    func refineResults(){
        
        resetRefineResults()
        
        if let selectedSort = selectedRefineOptions.sort.first {
            searchQueryRequest.order = selectedSort.order.rawValue
            searchQueryRequest.sort = selectedSort.type.rawValue
        }
        
        if let selectedCategory = selectedRefineOptions.category.first {
            searchQueryRequest.childCategory = selectedCategory.name
        }
        
        if let selectedBrand = selectedRefineOptions.brand.first {
            searchQueryRequest.brand = selectedBrand.name
        }

        searchQueryRequest.dietary = selectedRefineOptions.dietary.compactMap({ $0.name }).joined(separator: ",")
    }

}

extension ShowProductResultsInteractor {
    func resetRefineResults(){
        searchQueryRequest.sort = ""
        searchQueryRequest.order = ""
        searchQueryRequest.dietary = ""
        searchQueryRequest.brand = ""
        searchQueryRequest.childCategory = ""
    }
}

extension ShowProductResultsInteractor {
    func getListItems(request: ShowProductResults.GetListItems.Request){
        if let selectedListID = selectedListID {
            listItemWorker.getItems(listID: selectedListID) { (listItems: [ListItemModel]) in
                let response = ShowProductResults.GetListItems.Response(listItems: listItems)
                self.presenter?.presentListItems(response: response)
            }
        }
    }
    
    func createListItem(request: ShowProductResults.CreateListItem.Request){
        let listID: Int = request.listID
        let product: ProductModel = request.product
        
        listItemWorker.createItem(listID: listID, product: product) { (listItem: ListItemModel?, error: String?) in
            var response = ShowProductResults.CreateListItem.Response(listItem: listItem, error: error)
            
            if error != nil {
                response.offline = !self.userSession.isOnline()
            }
            
            self.presenter?.presentListItemCreated(response: response)
        }
    }
    
    func updateListItem(request: ShowProductResults.UpdateListItem.Request){
        let listID: Int = request.listID
        let productID: Int = request.productID
        let quantity: Int = request.quantity
        
        listItemWorker.updateItem(listID: listID, productID: productID, quantity: quantity, tickedOff: false) { (error: String?) in
            var response = ShowProductResults.UpdateListItem.Response(error: error)
            
            if error != nil {
                response.offline = !self.userSession.isOnline()
            }
            
            self.presenter?.presentListItemUpdated(response: response)
        }
    }
}
